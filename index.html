import React, { useState, useEffect } from 'react';
import { 
  Bell, 
  ReceiptText, 
  Eye, 
  EyeOff, 
  Send, 
  CreditCard, 
  FileText, 
  Wallet, 
  Smartphone, 
  Globe, 
  ShoppingBag, 
  Grid, 
  ScanBarcode, 
  LogOut, 
  Fingerprint, 
  ChevronRight, 
  ArrowRight, 
  ArrowLeft, 
  UserPlus, 
  Users, 
  Repeat, 
  PackageOpen, 
  CheckCircle2, 
  XCircle, 
  Banknote, 
  Share2, 
  Check, 
  Landmark,
  Delete // Menambahkan icon delete untuk keypad
} from 'lucide-react';

// --- Komponen Aset Logo & Grafis Sederhana ---

const WondrLogo = ({ size = "text-5xl", light = false }) => (
  <div className={`font-bold tracking-tighter flex flex-col items-center justify-center ${size} ${light ? 'text-white' : 'text-[#ff6600]'}`}>
    <div className="relative">
      <span>wondr</span>
      <div className="absolute bottom-1 left-[32%] w-[25%] h-[4px] bg-[#2dd4bf] rounded-full"></div>
    </div>
    <span className={`text-xs font-medium tracking-normal mt-0 ${light ? 'text-white' : 'text-gray-500'}`}>by BNI</span>
  </div>
);

// --- Ilustrasi Kotak dengan Jaring Laba-laba (Custom SVG) ---
const EmptyBoxIllustration = () => (
  <div className="relative w-40 h-32 flex items-center justify-center">
    {/* Background Teal Kotak */}
    <div className="absolute inset-0 bg-teal-300 rounded-xl transform rotate-1 scale-90 opacity-20"></div>
    <div className="absolute inset-0 bg-[#5eead4] rounded-xl flex items-center justify-center z-10">
       <svg width="100" height="100" viewBox="0 0 100 100" fill="none" xmlns="http://www.w3.org/2000/svg">
          {/* Kardus */}
          <path d="M20 40 L50 55 L80 40 L50 25 L20 40" fill="#f97316" stroke="black" strokeWidth="2" strokeLinejoin="round"/>
          <path d="M20 40 V70 L50 85 V55 M80 40 V70 L50 85" fill="#ea580c" stroke="black" strokeWidth="2" strokeLinejoin="round"/>
          <path d="M50 55 V85" stroke="black" strokeWidth="2"/>
          {/* Tutup Kardus Terbuka */}
          <path d="M20 40 L10 25" stroke="black" strokeWidth="2" strokeLinecap="round"/>
          <path d="M80 40 L90 25" stroke="black" strokeWidth="2" strokeLinecap="round"/>
          {/* Jaring Laba-laba */}
          <path d="M50 25 L50 55" stroke="white" strokeWidth="1"/>
          <path d="M50 40 L40 50 M50 40 L60 50" stroke="white" strokeWidth="1"/>
          <circle cx="50" cy="45" r="5" stroke="white" strokeWidth="1"/>
       </svg>
    </div>
  </div>
);

// --- Ilustrasi Sukses 3D Style (Shopping/Gift Theme) ---
const SuccessIllustration = () => (
    <div className="relative w-48 h-40 flex items-center justify-center mb-4">
      <svg width="200" height="160" viewBox="0 0 200 160" fill="none" xmlns="http://www.w3.org/2000/svg">
         {/* Background Elements (Abstract shapes) */}
         <circle cx="100" cy="80" r="70" fill="#ecfdf5" />
         
         {/* Shopping Bag (Teal) */}
         <rect x="70" y="50" width="60" height="70" rx="4" fill="#2dd4bf" />
         <path d="M70 50 H130 L125 120 H75 L70 50Z" fill="#14b8a6" />
         <path d="M85 50 V40 C85 32 92 32 100 32 C108 32 115 32 115 40 V50" stroke="#0f766e" strokeWidth="3" strokeLinecap="round" />
         
         {/* Small Box (Orange) */}
         <rect x="110" y="90" width="40" height="35" rx="2" fill="#fb923c" stroke="white" strokeWidth="2" />
         <path d="M110 90 L150 90 L145 125 H115 L110 90Z" fill="#f97316" />
         <path d="M130 90 V125" stroke="#fff" strokeWidth="1" opacity="0.5"/>
         
         {/* Paper Plane (Red/Orange accent) */}
         <path d="M40 40 L70 50 L40 60 L45 50 L40 40Z" fill="#ef4444" transform="rotate(-15 40 40)" />
         <path d="M45 50 L180 80" stroke="white" strokeWidth="2" strokeDasharray="4 4" strokeLinecap="round" pathLength="1" opacity="0.6">
            <animate attributeName="stroke-dashoffset" from="1" to="0" dur="1s" repeatCount="indefinite"/>
         </path>

         {/* Checkmark Circle (Green) - Floating */}
         <circle cx="150" cy="110" r="18" fill="#00cc88" stroke="white" strokeWidth="3" />
         <path d="M142 110 L147 115 L158 104" stroke="white" strokeWidth="3" strokeLinecap="round" strokeLinejoin="round" />
      </svg>
    </div>
);


// --- Halaman 1: Splash Screen ---
const SplashScreen = ({ onFinish }) => {
  useEffect(() => {
    const timer = setTimeout(() => {
      onFinish();
    }, 3000);
    return () => clearTimeout(timer);
  }, [onFinish]);

  return (
    <div className="h-full w-full bg-[#ff6600] relative flex flex-col items-center justify-center overflow-hidden font-sans">
      {/* Dekorasi Atas */}
      <div className="absolute -top-20 -left-20 w-64 h-64 bg-[#f0abfc] rounded-full opacity-100 z-0"></div>
      <div className="absolute -top-10 right-0 w-80 h-80 bg-[#d9f99d] rounded-full rounded-tr-none transform translate-x-20 -translate-y-20 z-0"></div>

      {/* Konten Tengah */}
      <div className="z-10 animate-pulse">
        <WondrLogo size="text-7xl" light={true} />
      </div>

      {/* Dekorasi Bawah */}
      <div className="absolute bottom-0 left-0 w-full h-1/3 bg-[#2dd4bf] rounded-tr-[100px] z-0 transform translate-y-20"></div>
      <div className="absolute bottom-0 right-0 w-2/3 h-1/4 bg-[#a78bfa] rounded-tl-[100px] z-0 transform translate-y-10"></div>

      {/* Footer Text */}
      <div className="absolute bottom-8 px-8 text-center text-xs text-teal-900/60 z-20 font-medium leading-relaxed">
        PT Bank Negara Indonesia (Persero) Tbk berizin dan diawasi oleh Otoritas Jasa Keuangan (OJK) & Bank Indonesia (BI) serta merupakan peserta penjaminan Lembaga Penjamin Simpanan (LPS).
      </div>
    </div>
  );
};

// --- Halaman 2: Login Page ---
const LoginPage = ({ onLogin }) => {
  return (
    <div className="h-full w-full bg-white relative flex flex-col justify-between font-sans">
      {/* Spacer atas */}
      <div className="flex-1 flex flex-col items-center justify-center mt-20">
        <WondrLogo size="text-6xl" />
      </div>

      {/* Quick Action Icons */}
      <div className="px-8 pb-8">
        <div className="flex justify-between items-start mb-10 px-2">
           <div className="flex flex-col items-center gap-2 w-1/4">
             <div className="w-14 h-14 bg-[#5eead4] rounded-2xl flex items-center justify-center shadow-sm">
               <Wallet className="text-teal-900" size={24} />
             </div>
             <span className="text-xs font-bold text-gray-800 text-center">E-Wallet</span>
           </div>
           <div className="flex flex-col items-center gap-2 w-1/4">
             <div className="w-14 h-14 bg-[#facc15] rounded-2xl flex items-center justify-center shadow-sm">
               <ScanBarcode className="text-yellow-900" size={24} />
             </div>
             <span className="text-xs font-bold text-gray-800 text-center">QRIS</span>
           </div>
           <div className="flex flex-col items-center gap-2 w-1/4">
             <div className="w-14 h-14 bg-[#fb923c] rounded-2xl flex items-center justify-center shadow-sm">
               <CreditCard className="text-orange-900" size={24} />
             </div>
             <span className="text-xs font-bold text-gray-800 text-center">TapCash</span>
           </div>
           <div className="flex flex-col items-center gap-2 w-1/4">
             <div className="w-14 h-14 bg-[#5eead4] rounded-2xl flex items-center justify-center shadow-sm">
               <Smartphone className="text-teal-900" size={24} />
             </div>
             <span className="text-xs font-bold text-gray-800 text-center">Mobile Tunai</span>
           </div>
        </div>

        {/* Login Button */}
        <button 
          onClick={onLogin}
          className="w-full bg-[#5eead4] h-14 rounded-full flex items-center justify-center gap-3 active:scale-95 transition-transform shadow-md mb-8"
        >
          <Fingerprint size={24} className="text-teal-900" />
          <span className="text-lg font-bold text-teal-900">Login</span>
        </button>

        {/* Dekorasi Sudut Bawah */}
        <div className="absolute -bottom-10 -left-10 w-40 h-40 bg-[#d9f99d] rounded-full z-0"></div>
        <div className="absolute -bottom-10 -right-10 w-32 h-32 bg-[#f0abfc] rounded-full z-0"></div>
      </div>
    </div>
  );
};

// --- Halaman Baru: PIN Page ---
const PinPage = ({ onBack, onSuccess, title = "Masukkan MPIN" }) => {
  const [pin, setPin] = useState("");

  const handlePress = (num) => {
    if (pin.length < 6) {
      setPin(prev => prev + num);
    }
  };

  const handleDelete = () => {
    setPin(prev => prev.slice(0, -1));
  };

  // Efek ketika PIN mencapai 6 digit
  useEffect(() => {
    if (pin.length === 6) {
      // Simulasi loading sebentar
      setTimeout(() => {
        // VALIDASI PIN SESUAI PERMINTAAN: 647077
        if (pin === '647077') {
            onSuccess();
            setPin("");
        } else {
            alert("PIN Salah. Silakan coba lagi.");
            setPin(""); // Reset PIN jika salah
        }
      }, 300);
    }
  }, [pin, onSuccess]);

  return (
    <div className="h-full w-full bg-white flex flex-col font-sans">
       {/* Header */}
       <div className="px-5 pt-6 pb-4 flex items-center gap-4 sticky top-0 z-20">
        <button onClick={onBack} className="p-1 -ml-1">
          <ArrowLeft size={24} className="text-black" />
        </button>
        <h1 className="text-xl font-bold text-black">Keamanan</h1>
      </div>

      <div className="flex-1 flex flex-col items-center pt-10">
        <h2 className="text-xl font-bold text-gray-900 mb-8">{title}</h2>
        
        {/* Dots Indicator */}
        <div className="flex gap-4 mb-20">
          {[...Array(6)].map((_, i) => (
            <div 
              key={i} 
              className={`w-4 h-4 rounded-full border border-gray-400 ${i < pin.length ? 'bg-[#ff6600] border-[#ff6600]' : 'bg-transparent'}`}
            ></div>
          ))}
        </div>

        {/* Numeric Keypad */}
        <div className="w-full px-10 grid grid-cols-3 gap-y-6 gap-x-8">
          {[1, 2, 3, 4, 5, 6, 7, 8, 9].map(num => (
            <button 
              key={num} 
              onClick={() => handlePress(num.toString())}
              className="h-16 w-16 rounded-full flex items-center justify-center text-3xl font-bold text-gray-800 active:bg-gray-100 mx-auto transition-colors"
            >
              {num}
            </button>
          ))}
          <div className="h-16 w-16"></div> {/* Spacer */}
          <button 
              onClick={() => handlePress("0")}
              className="h-16 w-16 rounded-full flex items-center justify-center text-3xl font-bold text-gray-800 active:bg-gray-100 mx-auto transition-colors"
            >
              0
          </button>
          <button 
              onClick={handleDelete}
              className="h-16 w-16 rounded-full flex items-center justify-center text-gray-800 active:bg-gray-100 mx-auto transition-colors"
            >
              <Delete size={28} />
          </button>
        </div>
      </div>
    </div>
  );
}

// --- Halaman 3: Dashboard Utama ---
const DashboardPage = ({ onLogout, onNavigate, balance }) => {
  const [showBalance, setShowBalance] = useState(true); // Default TRUE sesuai permintaan

  // Format saldo untuk tampilan: "Rp165.982.003"
  const formattedBalance = `Rp${balance.toLocaleString('id-ID')}`;

  // Data Menu Fitur
  const features = [
    { name: 'Transfer', icon: Send, color: 'bg-teal-100', iconColor: 'text-teal-700', action: () => onNavigate('transfer') },
    { name: 'TapCash', icon: CreditCard, color: 'bg-orange-100', iconColor: 'text-orange-600' },
    { name: 'Bayar & Beli', icon: FileText, color: 'bg-blue-100', iconColor: 'text-blue-600' },
    { name: 'E-Wallet', icon: Wallet, color: 'bg-teal-100', iconColor: 'text-teal-700', action: () => onNavigate('ewallet') },
    { name: 'Virtual Account', icon: Smartphone, color: 'bg-teal-100', iconColor: 'text-teal-700' },
    { name: 'Transfer LN', icon: Globe, color: 'bg-teal-100', iconColor: 'text-teal-700' },
    { name: 'Lifestyle', icon: ShoppingBag, color: 'bg-purple-100', iconColor: 'text-purple-700' },
    { name: 'Lihat Semua', icon: Grid, color: 'bg-gray-100', iconColor: 'text-gray-700' },
  ];

  return (
    <div className="h-full w-full bg-gray-50 overflow-y-auto font-sans pb-20">
      {/* Header */}
      <div className="bg-white px-5 pt-6 pb-4 sticky top-0 z-20">
        <div className="flex justify-between items-center mb-6">
          <div className="scale-75 origin-left">
            <WondrLogo size="text-3xl" />
          </div>
          <div className="flex gap-3">
            <div className="px-3 py-1 rounded-full border border-orange-500 flex items-center gap-1">
              <span className="text-xs font-bold text-gray-800">© Poin</span>
            </div>
            <button onClick={onLogout} className="w-8 h-8 rounded-full border border-gray-200 flex items-center justify-center">
              <LogOut size={14} className="text-gray-600" />
            </button>
          </div>
        </div>

        <div className="flex justify-between items-end mb-6">
          <div className="flex items-center gap-2">
             <h1 className="text-xl font-bold text-gray-900">Hi, Satriya!</h1>
          </div>
          <div className="flex gap-4 text-gray-600">
             <div className="flex flex-col items-center">
                <Bell size={20} />
                <span className="text-[10px] mt-1">Notifikasi</span>
             </div>
             <div className="flex flex-col items-center">
                <ReceiptText size={20} />
                <span className="text-[10px] mt-1">Bukti Transaksi</span>
             </div>
          </div>
        </div>

        {/* Tab Menu */}
        <div className="bg-gray-50 p-1 rounded-full flex justify-between mb-2">
           <button className="flex-1 py-2 text-sm font-medium text-gray-500 rounded-full">Insight</button>
           <button className="flex-1 py-2 text-sm font-bold text-gray-900 bg-[#d9f99d] rounded-full shadow-sm">Transaksi</button>
           <button className="flex-1 py-2 text-sm font-medium text-gray-500 rounded-full">Growth</button>
        </div>
      </div>

      {/* Scrollable Content */}
      <div className="px-5 pt-2">
        
        {/* Section Rekening */}
        <div className="flex justify-between items-center mb-3">
          <h2 className="font-bold text-lg text-gray-900">Rekening transaksi kamu</h2>
          <span className="text-orange-500 text-sm font-bold underline cursor-pointer">Lihat Semua</span>
        </div>

        {/* Card Rekening */}
        <div className="flex h-40 w-full mb-8 shadow-lg rounded-2xl overflow-hidden relative">
           {/* Left Side (Teal) */}
           <div className="w-1/3 bg-[#a5f3fc] flex flex-col items-center justify-center relative p-3 text-center">
             <div className="w-8 h-8 rounded-full bg-white flex items-center justify-center mb-2 shadow-sm border border-gray-100">
                <div className="w-5 h-5 rounded-full border-2 border-black border-t-transparent animate-spin-slow"></div>
             </div>
             <span className="text-xs font-semibold leading-tight text-teal-900">Lihat Portfolio</span>
             {/* Decorative curves */}
             <div className="absolute right-0 top-0 bottom-0 w-4 bg-white opacity-20 transform skew-x-12 translate-x-2"></div>
           </div>

           {/* Right Side (Orange Gradient) */}
           <div className="flex-1 bg-gradient-to-br from-orange-400 to-orange-300 p-4 relative">
             <div className="flex justify-between items-start mb-1">
               <div>
                  <p className="text-xs text-orange-900 font-semibold uppercase tracking-wide">TAPLUS</p>
                  <p className="text-lg font-bold text-gray-900 tracking-wider">1990943608</p>
               </div>
               <span className="bg-white/90 text-[10px] font-bold px-2 py-1 rounded-full text-orange-600">UTAMA</span>
             </div>

             <div className="mt-6 relative z-10">
                <p className="text-xs text-orange-900 mb-1">Saldo efektif</p>
                <div className="flex items-center gap-3">
                   <span className="text-2xl font-extrabold text-gray-900">
                     {showBalance ? formattedBalance : "Rp •••••••"}
                   </span>
                   <button onClick={() => setShowBalance(!showBalance)} className="text-gray-900 opacity-70 cursor-pointer">
                      {showBalance ? <EyeOff size={18} /> : <Eye size={18} />}
                   </button>
                </div>
             </div>
             {/* Circular decoration */}
             <div className="absolute -bottom-10 -right-5 w-32 h-32 bg-white opacity-10 rounded-full"></div>
           </div>
        </div>

        {/* Indikator Slider */}
        <div className="flex justify-center gap-2 mb-8">
           <div className="w-2 h-2 rounded-full bg-black"></div>
           <div className="w-2 h-2 rounded-full bg-gray-300"></div>
           <div className="w-2 h-2 rounded-full bg-gray-300"></div>
        </div>

        {/* Section Fitur */}
        <div className="flex justify-between items-center mb-4">
          <h2 className="font-bold text-lg text-gray-900">Fitur pilihan kamu</h2>
          <span className="text-orange-500 text-sm font-bold underline cursor-pointer">Atur</span>
        </div>

        <div className="grid grid-cols-4 gap-y-6 gap-x-2 mb-10">
           {features.map((item, idx) => (
             <div key={idx} onClick={item.action} className="flex flex-col items-center gap-2 cursor-pointer active:scale-95 transition-transform">
                <div className={`w-14 h-14 ${item.color} rounded-2xl flex items-center justify-center shadow-sm`}>
                   <item.icon className={item.iconColor} size={24} strokeWidth={2} />
                </div>
                <span className="text-[11px] font-semibold text-center leading-tight px-1 text-gray-800">{item.name}</span>
             </div>
           ))}
        </div>

        {/* Section Promo */}
        <div className="flex justify-between items-center mb-4">
          <h2 className="font-bold text-lg text-gray-900">Promo buat kamu</h2>
          <span className="text-orange-500 text-sm font-bold underline cursor-pointer">Lihat Semua</span>
        </div>

        <div className="w-full h-40 bg-[#d9f99d] rounded-2xl relative overflow-hidden flex items-center mb-10 border border-gray-100 shadow-md">
           <div className="w-1/2 p-5 z-10">
              <div className="inline-block bg-[#facc15] px-2 py-0.5 rounded-md text-[10px] font-bold mb-2 shadow-sm">Hingga 31 Des 2025</div>
              <h3 className="text-sm font-extrabold text-gray-900 leading-tight">Ajak Teman Kamu, Dapatkan Reward</h3>
           </div>
           
           {/* Decorative elements for promo */}
           <div className="absolute right-0 top-0 bottom-0 w-2/3 bg-[#8b5cf6] rounded-l-full transform translate-x-10 z-0"></div>
           <div className="absolute right-5 z-10 bg-black text-white px-3 py-1 rounded-lg text-xs font-mono font-bold tracking-widest border border-white">
              QRIS
           </div>
           {/* Stars */}
           <div className="absolute top-2 right-10 text-yellow-300 text-xs">✦</div>
           <div className="absolute bottom-4 right-20 text-yellow-300 text-lg">✦</div>
        </div>

      </div>
    </div>
  );
};

// --- Halaman 4: Transfer Page ---
const TransferPage = ({ onBack, onNavigate }) => {
  return (
    <div className="h-full w-full bg-[#f8f9fa] flex flex-col font-sans">
      {/* Header */}
      <div className="bg-white px-5 pt-6 pb-4 flex items-center gap-4 sticky top-0 z-20 shadow-sm">
        <button onClick={onBack} className="p-1 -ml-1">
          <ArrowLeft size={24} className="text-black" />
        </button>
        <h1 className="text-xl font-bold text-black">Transfer</h1>
      </div>

      {/* Main Content */}
      <div className="p-5 flex-1 overflow-y-auto">
        
        {/* Menu Cards */}
        <div className="flex items-center gap-2 mb-8">
          <div 
            onClick={() => onNavigate('transfer-form')}
            className="bg-white p-4 rounded-xl shadow-sm border border-gray-100 flex flex-col items-center justify-center w-[100px] h-[100px] flex-shrink-0 cursor-pointer active:bg-gray-50 transition-colors"
          >
             <div className="w-10 h-10 rounded-full border border-teal-500 flex items-center justify-center mb-2">
                <UserPlus size={20} className="text-teal-600" />
             </div>
             <span className="text-[10px] font-bold text-center text-black leading-tight">Penerima Baru</span>
          </div>

          <div className="bg-white p-4 rounded-xl shadow-sm border border-gray-100 flex flex-col items-center justify-center w-[100px] h-[100px] flex-shrink-0 opacity-60">
             <div className="w-10 h-10 rounded-full border border-teal-500 flex items-center justify-center mb-2">
                <Repeat size={20} className="text-teal-600" />
             </div>
             <span className="text-[10px] font-bold text-center text-black leading-tight">Diri Sendiri</span>
          </div>

          <div className="bg-white p-4 rounded-xl shadow-sm border border-gray-100 flex flex-col items-center justify-center w-[100px] h-[100px] flex-shrink-0 opacity-60">
             <div className="w-10 h-10 rounded-full border border-teal-500 flex items-center justify-center mb-2">
                <Users size={20} className="text-teal-600" />
             </div>
             <span className="text-[10px] font-bold text-center text-black leading-tight">Grup Baru</span>
          </div>
          
           {/* Dots Indicator */}
           <div className="flex flex-col gap-1 ml-1">
              <div className="w-1.5 h-1.5 bg-black rounded-full"></div>
              <div className="w-1.5 h-1.5 bg-gray-300 rounded-full"></div>
           </div>
        </div>

        {/* Tab Selection */}
        <div className="bg-gray-200/50 p-1 rounded-full flex justify-between mb-10">
           <button className="flex-1 py-2 text-sm font-bold text-black bg-[#d9f99d] rounded-full shadow-sm">Tersimpan</button>
           <button className="flex-1 py-2 text-sm font-medium text-gray-500 rounded-full">Terakhir</button>
        </div>

        {/* Empty State */}
        <div className="flex flex-col items-center justify-center mt-4">
           <EmptyBoxIllustration />
           
           <h3 className="text-lg font-bold text-black mt-6 mb-2 text-center">Kamu belum pernah simpan penerima</h3>
           <p className="text-sm text-gray-600 text-center leading-relaxed px-4">
             Yuk, transfer sekarang dan simpan penerimanya. Nanti kalau mau transfer, bisa langsung pilih dari daftar ini.
           </p>
        </div>

      </div>
    </div>
  );
};

// --- Halaman 5: Form Transfer ---
const TransferFormPage = ({ onBack, onSubmit }) => {
  const [formData, setFormData] = useState({
    rekening: '',
    bank: 'BNI', // Tambahan Default Bank
    nama: '',
    jumlah: '',
    catatan: ''
  });

  const handleChange = (e) => {
    const { name, value } = e.target;
    setFormData(prev => ({ ...prev, [name]: value }));
  };

  // Fungsi khusus untuk format uang (menambahkan titik otomatis)
  const handleAmountChange = (e) => {
    let value = e.target.value;
    
    // Hapus karakter non-digit
    const numberString = value.replace(/\D/g, '');
    
    // Format dengan titik setiap ribuan
    const formatted = numberString.replace(/\B(?=(\d{3})+(?!\d))/g, ".");
    
    setFormData(prev => ({ ...prev, jumlah: formatted }));
  };

  const handleNext = () => {
    // Bersihkan titik dari jumlah untuk validasi dan pengiriman data
    const rawAmount = parseInt(formData.jumlah.replace(/\./g, ''), 10);

    // Validasi sederhana: Cek apakah input utama terisi sebelum lanjut
    if (formData.rekening && formData.nama && rawAmount > 0) {
        // Kirim data dengan jumlah yang sudah berupa angka murni (jika diperlukan logika lanjut)
        // Namun untuk display status page, kita kirim objek yang disesuaikan
        const submitData = {
            ...formData,
            jumlah: rawAmount // Kirim sebagai number agar status page bisa memformat ulang
        };
        onSubmit(formData.catatan, submitData);
    } else {
        alert("Mohon lengkapi data rekening, nama, dan jumlah.");
    }
  };

  return (
    <div className="h-full w-full bg-[#f8f9fa] flex flex-col font-sans">
      {/* Header */}
      <div className="bg-white px-5 pt-6 pb-4 flex items-center gap-4 sticky top-0 z-20 shadow-sm">
        <button onClick={onBack} className="p-1 -ml-1">
          <ArrowLeft size={24} className="text-black" />
        </button>
        <h1 className="text-xl font-bold text-black">Penerima Baru</h1>
      </div>

      <div className="p-5 flex-1 overflow-y-auto">
        <div className="space-y-6">
            {/* Input Rekening */}
            <div className="space-y-2">
                <label className="text-xs font-bold text-gray-500 uppercase">Nomor Rekening</label>
                <div className="bg-white p-3 rounded-xl border border-gray-200 focus-within:border-teal-500 flex items-center gap-3">
                    <CreditCard size={20} className="text-gray-400" />
                    <input 
                        type="number" 
                        name="rekening"
                        value={formData.rekening}
                        onChange={handleChange}
                        className="w-full outline-none text-gray-900 font-bold placeholder-gray-300"
                        placeholder="Contoh: 1234567890"
                    />
                </div>
            </div>

            {/* Input Bank (Baru) */}
            <div className="space-y-2">
                <label className="text-xs font-bold text-gray-500 uppercase">Bank Tujuan</label>
                <div className="bg-white p-3 rounded-xl border border-gray-200 focus-within:border-teal-500 flex items-center gap-3">
                    <Landmark size={20} className="text-gray-400" />
                    <select 
                        name="bank"
                        value={formData.bank}
                        onChange={handleChange}
                        className="w-full outline-none text-gray-900 font-bold bg-transparent"
                    >
                        <option value="BNI">BNI</option>
                        <option value="BCA">BCA</option>
                        <option value="MANDIRI">MANDIRI</option>
                        <option value="BRI">BRI</option>
                        <option value="CIMB">CIMB NIAGA</option>
                        <option value="BSI">BSI</option>
                    </select>
                </div>
            </div>

            {/* Input Nama */}
            <div className="space-y-2">
                <label className="text-xs font-bold text-gray-500 uppercase">Nama Penerima</label>
                <div className="bg-white p-3 rounded-xl border border-gray-200 focus-within:border-teal-500 flex items-center gap-3">
                    <UserPlus size={20} className="text-gray-400" />
                    <input 
                        type="text" 
                        name="nama"
                        value={formData.nama}
                        onChange={handleChange}
                        className="w-full outline-none text-gray-900 font-bold placeholder-gray-300"
                        placeholder="Nama Lengkap"
                    />
                </div>
            </div>

             {/* Input Jumlah (Auto Format) */}
             <div className="space-y-2">
                <label className="text-xs font-bold text-gray-500 uppercase">Jumlah Transfer</label>
                <div className="bg-white p-3 rounded-xl border border-gray-200 focus-within:border-teal-500 flex items-center gap-3">
                    <Banknote size={20} className="text-gray-400" />
                    <input 
                        type="text" // Ubah ke text agar bisa menampilkan titik
                        name="jumlah"
                        value={formData.jumlah}
                        onChange={handleAmountChange}
                        className="w-full outline-none text-gray-900 font-bold placeholder-gray-300"
                        placeholder="0"
                    />
                </div>
            </div>

             {/* Input Catatan (Kunci Logika Sukses/Gagal) */}
             <div className="space-y-2">
                <label className="text-xs font-bold text-gray-500 uppercase">
                    Catatan
                </label>
                <div className="bg-white p-3 rounded-xl border border-gray-200 focus-within:border-teal-500 flex items-center gap-3">
                    <FileText size={20} className="text-gray-400" />
                    <input 
                        type="text" 
                        name="catatan"
                        value={formData.catatan}
                        onChange={handleChange}
                        className="w-full outline-none text-gray-900 font-medium placeholder-gray-300"
                        placeholder="Tulis catatan (Opsional)"
                    />
                </div>
            </div>
        </div>
      </div>

      {/* Button Bottom */}
      <div className="p-5 bg-white border-t border-gray-100">
        <button 
            onClick={handleNext}
            className="w-full bg-[#5eead4] h-12 rounded-full flex items-center justify-center gap-2 active:scale-95 transition-transform shadow-md font-bold text-teal-900"
        >
            Lanjut
        </button>
      </div>
    </div>
  );
};

// --- Halaman Baru: E-Wallet Page ---
const EWalletPage = ({ onBack, onSelectProvider }) => {
  const providers = [
    { name: 'GoPay', color: 'bg-blue-100', textColor: 'text-blue-600' },
    { name: 'OVO', color: 'bg-purple-100', textColor: 'text-purple-600' },
    { name: 'Dana', color: 'bg-sky-100', textColor: 'text-sky-600' },
    { name: 'ShopeePay', color: 'bg-orange-100', textColor: 'text-orange-600' },
    { name: 'LinkAja', color: 'bg-red-100', textColor: 'text-red-600' },
    { name: 'i.saku', color: 'bg-indigo-100', textColor: 'text-indigo-600' },
  ];

  return (
    <div className="h-full w-full bg-[#f8f9fa] flex flex-col font-sans">
      {/* Header */}
      <div className="bg-white px-5 pt-6 pb-4 flex items-center gap-4 sticky top-0 z-20 shadow-sm">
        <button onClick={onBack} className="p-1 -ml-1">
          <ArrowLeft size={24} className="text-black" />
        </button>
        <h1 className="text-xl font-bold text-black">E-Wallet</h1>
      </div>

      <div className="p-5 flex-1 overflow-y-auto">
        <h2 className="font-bold text-lg text-gray-900 mb-4">Pilih E-Wallet</h2>
        <div className="grid grid-cols-3 gap-4">
           {providers.map((item, idx) => (
             <div 
               key={idx} 
               onClick={() => onSelectProvider(item.name)}
               className="flex flex-col items-center gap-2 cursor-pointer active:scale-95 transition-transform bg-white p-4 rounded-2xl shadow-sm border border-gray-100"
             >
                <div className={`w-12 h-12 ${item.color} rounded-full flex items-center justify-center`}>
                   <Wallet className={item.textColor} size={24} />
                </div>
                <span className="text-xs font-bold text-center text-gray-800">{item.name}</span>
             </div>
           ))}
        </div>
      </div>
    </div>
  );
};

// --- Halaman Baru: E-Wallet Form Page ---
const EWalletFormPage = ({ onBack, provider, onSubmit }) => {
  const [formData, setFormData] = useState({
    phone: '',
    amount: '',
    catatan: ''
  });

  // Format uang otomatis
  const handleAmountChange = (e) => {
    let value = e.target.value;
    const numberString = value.replace(/\D/g, '');
    const formatted = numberString.replace(/\B(?=(\d{3})+(?!\d))/g, ".");
    setFormData(prev => ({ ...prev, amount: formatted }));
  };

  const handleChange = (e) => {
    const { name, value } = e.target;
    setFormData(prev => ({ ...prev, [name]: value }));
  };

  const handleNext = () => {
    const rawAmount = parseInt(formData.amount.replace(/\./g, ''), 10);
    if (formData.phone && rawAmount > 0) {
        const submitData = {
            nama: provider, // Menampilkan nama provider sebagai tujuan
            rekening: formData.phone,
            bank: 'E-Wallet',
            jumlah: rawAmount
        };
        onSubmit(formData.catatan, submitData);
    } else {
        alert("Mohon lengkapi nomor HP dan nominal.");
    }
  };

  return (
    <div className="h-full w-full bg-[#f8f9fa] flex flex-col font-sans">
      {/* Header */}
      <div className="bg-white px-5 pt-6 pb-4 flex items-center gap-4 sticky top-0 z-20 shadow-sm">
        <button onClick={onBack} className="p-1 -ml-1">
          <ArrowLeft size={24} className="text-black" />
        </button>
        <h1 className="text-xl font-bold text-black">Top Up {provider}</h1>
      </div>

      <div className="p-5 flex-1 overflow-y-auto">
        <div className="space-y-6">
            {/* Input Phone */}
            <div className="space-y-2">
                <label className="text-xs font-bold text-gray-500 uppercase">Nomor Handphone</label>
                <div className="bg-white p-3 rounded-xl border border-gray-200 focus-within:border-teal-500 flex items-center gap-3">
                    <Smartphone size={20} className="text-gray-400" />
                    <input 
                        type="number" 
                        name="phone"
                        value={formData.phone}
                        onChange={handleChange}
                        className="w-full outline-none text-gray-900 font-bold placeholder-gray-300"
                        placeholder="Contoh: 08123456789"
                    />
                </div>
            </div>

             {/* Input Amount */}
             <div className="space-y-2">
                <label className="text-xs font-bold text-gray-500 uppercase">Nominal Top Up</label>
                <div className="bg-white p-3 rounded-xl border border-gray-200 focus-within:border-teal-500 flex items-center gap-3">
                    <Banknote size={20} className="text-gray-400" />
                    <input 
                        type="text"
                        name="amount"
                        value={formData.amount}
                        onChange={handleAmountChange}
                        className="w-full outline-none text-gray-900 font-bold placeholder-gray-300"
                        placeholder="0"
                    />
                </div>
            </div>

             {/* Input Catatan */}
             <div className="space-y-2">
                <label className="text-xs font-bold text-gray-500 uppercase">
                    Catatan
                </label>
                <div className="bg-white p-3 rounded-xl border border-gray-200 focus-within:border-teal-500 flex items-center gap-3">
                    <FileText size={20} className="text-gray-400" />
                    <input 
                        type="text" 
                        name="catatan"
                        value={formData.catatan}
                        onChange={handleChange}
                        className="w-full outline-none text-gray-900 font-medium placeholder-gray-300"
                        placeholder="Tulis catatan (Opsional)"
                    />
                </div>
            </div>
        </div>
      </div>

      {/* Button Bottom */}
      <div className="p-5 bg-white border-t border-gray-100">
        <button 
            onClick={handleNext}
            className="w-full bg-[#5eead4] h-12 rounded-full flex items-center justify-center gap-2 active:scale-95 transition-transform shadow-md font-bold text-teal-900"
        >
            Lanjut
        </button>
      </div>
    </div>
  );
};

// --- Halaman 6: Status Page (Updated) ---
const StatusPage = ({ isSuccess, onHome, transactionData }) => {
    // Ambil data dari transaksi terakhir, jika tidak ada gunakan default dummy
    const { 
        nama = 'AGUS WIDODO', 
        rekening = '1836954270', 
        jumlah = '27919', 
        bank = 'BNI', // Default bank jika data tidak ada
        timestamp = '29 Nov 2025 • 04:52:02 WIB', // Default timestamp
        refID = '20251129045202000499' // Default Ref ID
    } = transactionData || {};

    // Format mata uang sederhana
    const formattedJumlah = new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 }).format(jumlah).replace('IDR', 'Rp');

    if (!isSuccess) {
        return (
            <div className="h-full w-full bg-white flex flex-col items-center justify-center p-6 relative">
                 <div className="mb-6 animate-bounce">
                    <XCircle size={80} className="text-red-500" />
                 </div>
                 <h2 className="text-2xl font-bold mb-2 text-red-600">Transaksi Gagal</h2>
                 <p className="text-gray-500 text-center text-sm mb-10 leading-relaxed px-4">
                    Maaf, Rekening atau kontak penerima saat ini sedang menjalani maintenance system. Silahkan coba lagi dalam beberapa jam kedepan.
                 </p>
                <button onClick={onHome} className="w-full bg-gray-100 text-gray-800 h-12 rounded-full font-bold active:scale-95 transition-transform">
                    Kembali ke Dashboard
                </button>
                 <div className="absolute top-0 left-0 w-full h-2 bg-red-400"></div>
            </div>
        )
    }

    return (
        <div className="h-full w-full bg-white flex flex-col items-center pt-20 pb-6 px-6 font-sans relative overflow-hidden">
             
             {/* Animasi Icon/Ilustrasi */}
             <div className="z-10 animate-fade-in-up">
               <SuccessIllustration />
             </div>

             <h2 className="text-xl font-bold mb-1 text-black z-10">Transaksi berhasil!</h2>
             
             {/* Nominal Besar */}
             <h1 className="text-4xl font-extrabold text-black mb-2 z-10">{formattedJumlah}</h1>
             
             {/* Meta Data */}
             <div className="flex flex-col items-center text-xs font-medium text-gray-500 mb-8 z-10">
                <span>{timestamp} •</span>
                <span>Ref ID: {refID}</span>
             </div>

             {/* Action Buttons (Orange) */}
             <div className="flex gap-4 w-full justify-center mb-8 z-10">
                <button className="flex flex-col items-center justify-center w-24 h-24 bg-[#ff6600] text-white rounded-2xl active:scale-95 transition shadow-sm">
                   <div className="w-8 h-8 mb-2 flex items-center justify-center border-2 border-white rounded-lg">
                      <ReceiptText size={16} />
                   </div>
                   <span className="text-[10px] font-bold">Bukti Transaksi</span>
                </button>
                <button className="flex flex-col items-center justify-center w-24 h-24 bg-[#ff6600] text-white rounded-2xl active:scale-95 transition shadow-sm">
                   <div className="w-8 h-8 mb-2 flex items-center justify-center border-2 border-white rounded-lg">
                      <Share2 size={16} />
                   </div>
                   <span className="text-[10px] font-bold">Bagikan</span>
                </button>
             </div>

             {/* Detail Transaksi Boxes */}
             <div className="w-full space-y-4 mb-auto z-10">
                {/* Tujuan */}
                <div className="w-full">
                    <p className="text-xs text-gray-500 mb-1 ml-1">Tujuan</p>
                    <div className="w-full border border-gray-300 rounded-xl p-3 bg-white">
                        <p className="font-bold text-sm text-black">{nama}</p>
                        <p className="text-xs text-gray-500">{bank} • {rekening}</p>
                    </div>
                </div>

                 {/* Sumber Dana */}
                 <div className="w-full">
                    <p className="text-xs text-gray-500 mb-1 ml-1">Sumber dana</p>
                    <div className="w-full border border-gray-300 rounded-xl p-3 bg-white">
                        <p className="font-bold text-sm text-black">SATRIYA</p>
                        <p className="text-xs text-gray-500">TAPLUS • *******608</p>
                    </div>
                </div>
             </div>

            {/* Footer Button */}
            <button 
                onClick={onHome}
                className="w-full bg-[#5eead4] text-teal-900 h-14 rounded-full font-bold text-lg active:scale-95 transition-transform z-10 shadow-lg mt-4"
            >
                Kembali ke Beranda
            </button>
             
             {/* Decorative Background Shapes */}
             <div className="absolute top-10 left-[-50px] w-40 h-40 bg-[#d9f99d] rounded-full opacity-50 z-0 blur-xl"></div>
             <div className="absolute bottom-[-20px] right-[-20px] w-64 h-64 bg-[#ccfbf1] rounded-full opacity-60 z-0 blur-xl"></div>
        </div>
    );
};

// --- Main App Component ---
export default function WondrApp() {
  const [currentPage, setCurrentPage] = useState('splash'); // splash, login, pin, dashboard, transfer, transfer-form, status, ewallet, ewallet-form
  const [transactionSuccess, setTransactionSuccess] = useState(false);
  const [lastTransaction, setLastTransaction] = useState(null);
  const [selectedEWallet, setSelectedEWallet] = useState(null);
  
  // State Saldo Global
  const [balance, setBalance] = useState(165982003); // Saldo awal

  // State baru untuk konteks PIN (Login atau Transaksi)
  const [pinContext, setPinContext] = useState(null); // { type: 'LOGIN' | 'TRANSACTION', note: string, data: object }

  const handleSplashFinish = () => {
    setCurrentPage('login');
  };

  const handleLogin = () => {
    // Alih-alih langsung ke dashboard, set context login dan ke halaman PIN
    setPinContext({ type: 'LOGIN' });
    setCurrentPage('pin');
  };

  const handleLogout = () => {
    setCurrentPage('login');
  };

  const handleNavigate = (page) => {
    setCurrentPage(page);
  };

  const handleSelectEWallet = (provider) => {
      setSelectedEWallet(provider);
      setCurrentPage('ewallet-form');
  };

  // Fungsi baru untuk menangani sukses PIN
  const handlePinSuccess = () => {
    if (pinContext?.type === 'LOGIN') {
      setCurrentPage('dashboard');
    } else if (pinContext?.type === 'TRANSACTION') {
      executeTransaction(pinContext.note, pinContext.data);
    }
  };

  // Fungsi inisiasi transaksi (sebelum PIN)
  const handleTransactionSubmit = (note, data) => {
      setPinContext({ type: 'TRANSACTION', note, data });
      setCurrentPage('pin');
  };

  // Logika Eksekusi Transaksi (Setelah PIN)
  const executeTransaction = (note, data) => {
      // Ambil waktu sekarang untuk Real-time Timestamp
      const now = new Date();
      
      const dateOptions = { day: '2-digit', month: 'short', year: 'numeric' };
      const dateStr = now.toLocaleDateString('id-ID', dateOptions);
      
      const timeOptions = { hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false };
      const timeStr = now.toLocaleTimeString('id-ID', timeOptions).replace(/\./g, ':');
      
      const yyyy = now.getFullYear();
      const mm = String(now.getMonth() + 1).padStart(2, '0');
      const dd = String(now.getDate()).padStart(2, '0');
      const hh = String(now.getHours()).padStart(2, '0');
      const min = String(now.getMinutes()).padStart(2, '0');
      const ss = String(now.getSeconds()).padStart(2, '0');
      const random = Math.floor(100000 + Math.random() * 900000);
      const refID = `${yyyy}${mm}${dd}${hh}${min}${ss}${random}`;

      const fullTransactionData = {
          ...data,
          timestamp: `${dateStr} • ${timeStr} WIB`,
          refID: refID
      };

      // Jika catatan terisi (length > 0) -> Sukses
      // Jika catatan kosong -> Gagal
      if (note && note.trim().length > 0) {
          setTransactionSuccess(true);
          // Kurangi saldo jika sukses
          setBalance(prev => prev - data.jumlah);
      } else {
          setTransactionSuccess(false);
      }
      
      setLastTransaction(fullTransactionData);
      setCurrentPage('status');
  };

  return (
    <div className="flex justify-center items-center min-h-screen bg-gray-200 p-4 font-sans">
      <div className="w-full max-w-sm h-[800px] bg-white rounded-[40px] shadow-2xl overflow-hidden relative border-8 border-gray-900">
        
        {currentPage === 'splash' && <SplashScreen onFinish={handleSplashFinish} />}
        {currentPage === 'login' && <LoginPage onLogin={handleLogin} />}
        
        {/* Halaman Baru: PIN Page */}
        {currentPage === 'pin' && (
            <PinPage 
                onBack={() => {
                    // Back logic: If login context -> back to login page, else back to previous form
                    if (pinContext?.type === 'LOGIN') setCurrentPage('login');
                    else if (pinContext?.type === 'TRANSACTION') {
                        // Determine which form based on data structure or simple history check
                        // For simplicity, returning to dashboard or checking data type
                        if (pinContext.data.bank === 'E-Wallet') setCurrentPage('ewallet-form');
                        else setCurrentPage('transfer-form');
                    }
                }}
                onSuccess={handlePinSuccess}
                title={pinContext?.type === 'LOGIN' ? "Masukkan MPIN" : "Konfirmasi Transaksi"}
            />
        )}

        {currentPage === 'dashboard' && <DashboardPage onLogout={handleLogout} onNavigate={handleNavigate} balance={balance} />}
        {currentPage === 'transfer' && <TransferPage onBack={() => handleNavigate('dashboard')} onNavigate={handleNavigate} />}
        
        {currentPage === 'transfer-form' && (
            <TransferFormPage 
                onBack={() => handleNavigate('transfer')} 
                onSubmit={handleTransactionSubmit}
            />
        )}

        {currentPage === 'ewallet' && (
            <EWalletPage 
                onBack={() => handleNavigate('dashboard')}
                onSelectProvider={handleSelectEWallet}
            />
        )}

        {currentPage === 'ewallet-form' && (
            <EWalletFormPage 
                onBack={() => handleNavigate('ewallet')}
                provider={selectedEWallet}
                onSubmit={handleTransactionSubmit}
            />
        )}

        {currentPage === 'status' && (
            <StatusPage 
                isSuccess={transactionSuccess} 
                onHome={() => handleNavigate('dashboard')} 
                transactionData={lastTransaction}
            />
        )}

        {/* Bottom Home Indicator */}
        <div className="absolute bottom-2 left-1/2 transform -translate-x-1/2 w-32 h-1.5 bg-black/20 rounded-full z-50"></div>
      </div>
    </div>
  );
}